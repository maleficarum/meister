name: On Push
env:
  AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

on:
    push:
        branches:
            - main
            - development
jobs:
    plan:
        name: Plan terraform
        uses: ./.github/workflows/pr.yml

    apply:
        name: 'Terragrunt'
        needs: plan
        runs-on: 'self-hosted'
        environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    
        steps:
            - name: 'Terragrunt Apply'
              run: cd ${GITHUB_WORKSPACE}/environments/${environment} && terragrunt run-all apply --terragrunt-non-interactive
              shell: bash  
            - name: 'Fetch domain name'
              run: cd ${GITHUB_WORKSPACE}/environments/${environment} && terragrunt run-all output | grep domain_name
              shell: bash  